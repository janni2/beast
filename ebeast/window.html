<!DOCTYPE html> <!-- GNU LGPL v2.1+: http://www.gnu.org/licenses/lgpl.html -->
<html><head>

  <title>Beast - Music Synthesizer and Composer</title>

  <link rel="stylesheet" href="assets/stylesheets.css">
  <link rel="stylesheet" href="assets/material-icons.css">
  <link rel="stylesheet" href="assets/forkawesome-webfont.css">

  <script> /* Load Electron, Bse, Vue, setup DevTools and Util */
  'use strict';

  // stderr logging of console messages
  if (console !== undefined) {
    const duplog = function (ofun) {
      return function() {
	process.stderr.write ([...arguments].join (' ') + '\n');
	return ofun.call (this, ...arguments);
      };
    };
    console.log = duplog (console.log);
    console.info = duplog (console.info);
    console.warn = duplog (console.warn);
    console.error = duplog (console.error);
  }
  // log all errors
  window.addEventListener ('error', event => {
    const errmsg = event.filename + ':' + event.lineno + ': Error: ' + event.message;
    console.log (errmsg);
  });
  const assert = console.assert;

  // load Electronjs utilities
  const Electron = require ('electron').remote;
  // provide global constants
  const MAXINT = 2147483647, MAXUINT = 4294967295;
  { MAXINT; MAXUINT; } // linter: not unused
  const GLOBALCONFIG = Object.freeze (Electron.getCurrentWindow().GLOBALCONFIG);
  // show DevTools on hotkey
  if (GLOBALCONFIG.debug)
    document.addEventListener ("keydown", (event) => {
      const code = event.which || event.keyCode;
      if (event.shiftKey && event.ctrlKey && code == 73) // Shift+Ctrl+I
	Electron.getCurrentWindow().toggleDevTools();
      if (event.shiftKey && event.ctrlKey && code == 82) // Shift+Ctrl+R
	window.location.reload();
      // Electron.getCurrentWindow().webContents.setZoomFactor (1);
    });

  window.BEASTDIR = __dirname + '/../'; // $prefix/beast-$VESION/app/../
  // pull in jQuery
  console.assert (window.jQuery === undefined);
  const $ = require ('jquery');
  window.$ = window.jQuery = $;
  // initialize BSE plus binding
  const Bse = require ('./assets/v8bse.node'); // adding './' avoids node_modules/-relative lookup
  const _ = (txt) => { return Bse.server.gettext (txt); };   // translation indicator
  { Bse; _; } // linter: not unused
  // load and configure Vue
  console.assert (window.Vue === undefined);
  const Vue = require ('vue/dist/vue.common.js');
  window.Vue = Vue;
  Vue.config.productionTip = false;
  Vue.config.silent = !GLOBALCONFIG.debug;
  Vue.config.devtools = false; // prevent warning about VUEJS_DEVTOOLS missing
  Vue.prototype._ = _;
  // install utilities, some are needed by Vue components
  const Util = require ('./assets/utilities.js');
  // load Vue components, bundled via b/bundle.js
  require ('./assets/components.js'); // adding './' avoids node_modules/-relative lookup
  // enable simple logging everywhere
  window.$log = console.log.bind (console);
  Vue.prototype.$log = window.$log;
  </script>

</head>
<body>

  <div id="vue-mountpoint">
    <b-projectshell ref="Vue-prototype-Shell" ></b-projectshell>
    <b-aboutdialog v-if="Shell.show_about_dialog" @close="Shell.show_about_dialog = false"></b-aboutdialog>
    <b-preferencesdialog v-if="Shell.show_preferences_dialog" @close="Shell.show_preferences_dialog = false"></b-preferencesdialog>
  </div>

  <script>
  {
    // Shell will inject itself into all Vue components, make it global
    Object.defineProperty (window, 'Shell', { get: () => Vue.prototype.Shell, });
    // App.Shell placeholder until the Shell VueComponent is created
    const shell_placeholder = {
      show_about_dialog: false,
      show_preferences_dialog: false,
      Shell_placeholder: true		// flag causing replacement later on
    };
    // Create Vue root instance, which immediately creates Shell
    const vue_mountpoint = new Vue ({
      el:   '#vue-mountpoint',
      data: { Shell: shell_placeholder },
    });
    assert (vue_mountpoint); // $root
    document.fonts.ready.then (() => {
      function vue_update (component) {
	component.$forceUpdate();
	for (let child of component.$children)
	  vue_update (child);
      };
      vue_update (vue_mountpoint);
    });
  }
  { // setup menubar
    const menus = require ('./menus.js');
    menus.setup_app_menu();
  }
  // load args
  for (let arg of GLOBALCONFIG.args)
    {
      if (Shell.load_project (arg) == Bse.Error.NONE)
	;
      else
	console.error ('Failed to load:', arg);
    }
  </script>

</body>
</html>
